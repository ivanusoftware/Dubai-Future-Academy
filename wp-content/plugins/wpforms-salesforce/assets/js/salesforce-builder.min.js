"use strict";WPForms.Admin.Builder.Providers.Salesforce=WPForms.Admin.Builder.Providers.Salesforce||function(o,e,r){var c={$holder:null,config:{templates:["wpforms-salesforce-builder-content-connection","wpforms-salesforce-builder-content-connection-required-fields","wpforms-salesforce-builder-content-connection-error","wpforms-salesforce-builder-content-connection-lock","wpforms-salesforce-builder-content-connection-conditionals"]},replaceConnectionIds:function(o,e){e.find("input, textarea, select, label").each(function(){var e=r(this);e.attr("name")&&e.attr("name",e.attr("name").replace(/%connection_id%/gi,o)),e.attr("id")&&e.attr("id",e.attr("id").replace(/%connection_id%/gi,o)),e.attr("for")&&e.attr("for",e.attr("for").replace(/%connection_id%/gi,o)),e.attr("data-name")&&e.attr("data-name",e.attr("data-name").replace(/%connection_id%/gi,o))})},connectionAccountExists:function(e,o){return!_.isEmpty(o)&&(!!_.isEmpty(e)||_.has(o,e))}},a={provider:"salesforce",Providers:{},Templates:{},Cache:{},isReady:!1,init:function(){r(function(){_.isObject(e.wpformsSalesforceBuilderVars)&&_.has(e.wpformsSalesforceBuilderVars,"authNotice")&&a.modal(wpformsSalesforceBuilderVars.authNotice)}),"providers"===wpf.getQueryString("view")&&r("#wpforms-panel-providers").on("WPForms.Admin.Builder.Providers.ready",a.ready),r(o).on("wpformsPanelSwitched",function(e,o){"providers"===o&&a.ready()})},ready:function(){a.isReady||(a.Providers=WPForms.Admin.Builder.Providers,a.Templates=WPForms.Admin.Builder.Templates,a.Cache=a.Providers.cache,c.$holder=a.Providers.getProviderHolder(a.provider).find(".wpforms-builder-provider-connections"),a.Templates.add(c.config.templates),a.Providers.ui.account.registerAddHandler(a.provider,a.processAccountAdd),a.bindUIActions(),a.bindTriggers(),a.processInitial(),a.isReady=!0)},bindUIActions:function(){a.Providers.getProviderHolder(a.provider).on("connectionCreate",a.connection.callbacks.create).on("connectionDelete",a.connection.callbacks.delete).on("change",".js-wpforms-builder-salesforce-provider-connection-account",a.ui.account.changeCallback).on("change",".js-wpforms-builder-salesforce-provider-connection-object",a.ui.object.changeCallback),r(o).on("click",".wpforms-salesforce-setting-field-redirect-copy",a.ui.copyUrlClick)},bindTriggers:function(){c.$holder.on("connectionsDataLoaded",function(e,o){if(!_.isEmpty(o.connections))for(var n in o.connections)a.connection.callbacks.generate({connection:o.connections[n],conditional:o.conditionals[n]})}),c.$holder.on("connectionGenerated",function(e,o){var n=a.connection.getById(o.connection.id);_.has(o.connection,"isNew")&&o.connection.isNew?c.replaceConnectionIds(o.connection.id,n):r(".js-wpforms-builder-salesforce-provider-connection-object",n).trigger("change",[n])})},processInitial:function(){c.$holder.prepend(a.tmpl.callbacks.commonsHTML()),a.connection.callbacks.dataLoad()},processAccountAdd:function(e){var o=e.$content.find("form"),n=e.$content.find(".error"),t=o.find('input[name="client_id"]'),r=o.find('input[name="client_secret"]'),i=t.val().trim(),c=r.val().trim();return _.isEmpty(i)||_.isEmpty(c)?(n.show(),e.setType("red"),t.addClass("wpforms-error"),r.addClass("wpforms-error")):(n.hide(),e.setType("blue"),t.removeClass("wpforms-error"),r.removeClass("wpforms-error"),a.Providers.ajax.request(a.provider,{data:{task:"account_save",data:{client_id:i,client_secret:c}}}).done(function(e){return e.success?(o.find('input[name="state"]').val(wpf.sanitizeHTML(e.data.state)),wpf.savedState=wpf.getFormState("#wpforms-builder-form"),void o.submit()):(_.has(e,"data")&&_.has(e.data,"error_msg")&&n.html(e.data.error_msg),void n.show())})),!1},connection:{getById:function(e){return c.$holder.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},callbacks:{create:function(e,o){var n=(new Date).getTime().toString(16),o={id:n,name:o,isNew:!0};a.Cache.addTo(a.provider,"connections",n,o),a.connection.callbacks.generate({connection:o})},delete:function(e,o){var n=a.Providers.getProviderHolder(a.provider);o.closest(n).length&&(o=o.data("connection_id"),_.isString(o)&&a.Cache.deleteFrom(a.provider,"connections",o))},generate:function(o){var n=a.Templates.get("wpforms-"+a.provider+"-builder-content-connection"),e=r("#tmpl-wpforms-"+a.provider+"-builder-content-connection-conditionals").length?a.Templates.get("wpforms-"+a.provider+"-builder-content-connection-conditionals"):a.Templates.get("wpforms-providers-builder-content-connection-conditionals"),t=_.has(o.connection,"isNew")&&o.connection.isNew?e():o.conditional,e=a.Cache.get(a.provider,"accounts");_.isEmpty(e)?a.Providers.ajax.request(a.provider,{data:{task:"accounts_get"}}).done(function(e){e.success&&_.has(e.data,"accounts")&&(a.Cache.set(a.provider,"accounts",e.data.accounts),c.connectionAccountExists(o.connection.account_id,e.data.accounts)&&(c.$holder.prepend(n({objects:a.Cache.get(a.provider,"objects"),accounts:e.data.accounts,connection:o.connection,conditional:t,provider:a.provider})),c.$holder.trigger("connectionGenerated",[o])))}):c.connectionAccountExists(o.connection.account_id,e)&&(c.$holder.prepend(n({objects:a.Cache.get(a.provider,"objects"),accounts:e,connection:o.connection,conditional:t,provider:a.provider})),c.$holder.trigger("connectionGenerated",[o]))},dataLoad:function(){a.Providers.ajax.request(a.provider,{data:{task:"connections_get"}}).done(function(e){e.success&&_.has(e.data,"connections")&&(a.Cache.set(a.provider,"connections",jQuery.extend({},e.data.connections)),a.Cache.set(a.provider,"conditionals",jQuery.extend({},e.data.conditionals)),a.Cache.set(a.provider,"objects",jQuery.extend({},e.data.objects)),_.isEmpty(e.data.accounts)||a.Cache.set(a.provider,"accounts",jQuery.extend({},e.data.accounts)),c.$holder.trigger("connectionsDataLoaded",[e.data]))})}}},ui:{account:{changeCallback:function(){var e=r(this),o=e.closest(".wpforms-builder-provider-connection"),n=r(".js-wpforms-builder-salesforce-provider-connection-object",o);r(".wpforms-builder-salesforce-provider-actions-data",o).empty(),n.prop("selectedIndex",0),_.isEmpty(e.val())?n.prop("disabled",!0):(n.prop("disabled",!1),e.removeClass("wpforms-error"))}},object:{changeCallback:function(){var e=r(this),o=e.closest(".wpforms-builder-provider-connection"),n=r(".js-wpforms-builder-salesforce-provider-connection-account",o);r(".wpforms-builder-salesforce-provider-actions-data",o).empty(),e.removeClass("wpforms-error"),a.actions.init({action:"object_create",target:e,option_id:n.find("option:selected").data("option_id"),account_id:n.val(),connection_id:o.data("connection_id")})}},copyUrlClick:function(){var e=r(this);r("#"+e.data("source_id")).get(0).select(),o.execCommand("Copy"),e.removeClass("animate"),this.offsetWidth,e.addClass("animate")}},actions:{init:function(e){"object_create"===e.action&&a.actions.object.create.init(e)},object:{create:{init:function(e){var o=a.Cache.get(a.provider,"customFields");_.isObject(o)&&!_.isEmpty(o)&&_.has(o,e.account_id)&&_.has(o[e.account_id],e.target.val())?this.render(e):this.request(e)},request:function(t){var r=this,i=t.target.val();a.Providers.ajax.request(a.provider,{data:{task:"object_data_get",object_name:i,option_id:t.option_id}}).done(function(e){var o,n;e.success&&!_.isEmpty(e.data)?(o=a.Cache.get(a.provider,"customFields"),n={},_.isUndefined(o)&&(o={},a.Cache.set(a.provider,"customFields",o)),_.has(o,t.account_id)||(o[t.account_id]={},a.Cache.set(a.provider,"customFields",o)),(n=o[t.account_id])[i]=e.data,a.Cache.addTo(a.provider,"customFields",t.account_id,n),r.render(t)):c.$holder.find(".wpforms-builder-provider-connections-error").show()})},render:function(e){var o=wpf.getFields(),n=a.tmpl.callbacks.optionalFieldsHTML(e,o),t=a.tmpl.callbacks.requiredFieldsHTML(e,o),o=a.connection.getById(e.connection_id);o.find(".wpforms-builder-salesforce-provider-actions-data").html(n),_.isEmpty(t)||o.find(".wpforms-builder-provider-connection-fields-table tbody").prepend(t),c.$holder.trigger("connectionRendered",[a.provider,e.connection_id])}}}},tmpl:{callbacks:{commonsHTML:function(){var e=a.Templates.get("wpforms-"+a.provider+"-builder-content-connection-error"),o=a.Templates.get("wpforms-"+a.provider+"-builder-content-connection-lock");return e()+o({provider:a.provider})},optionalFieldsHTML:function(e,o){var n,t=e.target.val(),r=a.Templates.get("wpforms-providers-builder-content-connection-fields"),i=a.Cache.getById(a.provider,"customFields",e.account_id),e=a.Cache.getById(a.provider,"connections",e.connection_id);return e.object!==t?((n=_.clone(e)).fields_meta=[],n.fields_required=[]):n=e,r({connection:n,fields:o,provider:{placeholder:wpformsSalesforceBuilderVars.l10n.provider_placeholder,slug:a.provider,fields:i[t].optional}})},requiredFieldsHTML:function(e,o){var n=a.Templates.get("wpforms-"+a.provider+"-builder-content-connection-required-fields"),t=a.Cache.getById(a.provider,"customFields",e.account_id);return _.has(t[e.target.val()],"required")?n({connection:a.Cache.getById(a.provider,"connections",e.connection_id),fields:o,provider:{slug:a.provider,fields:t[e.target.val()].required}}):""}}},modal:function(e){var o=wpforms_builder.heads_up,n="fa fa-exclamation-circle",t="orange";_.has(e,"type")&&_.has(e,"message")&&("success"===e.type&&(o=wpforms_builder.saved,n="fa fa-check-circle",t="green"),r.alert({title:o,content:e.message,icon:n,type:t,buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}}))}};return a}(document,window,jQuery),WPForms.Admin.Builder.Providers.Salesforce.init();